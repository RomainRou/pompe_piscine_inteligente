blueprint:
  name: Pompe piscine intelligente - tous modes (avec Telegram)
  description: >
    ğŸ’§ GÃ¨re automatiquement la pompe de piscine selon :<br>
    - ğŸ•‘ Heures fixes configurables (2 cycles/jour + 2 intermÃ©diaire)<br>
    - ğŸŒ¡ï¸ TempÃ©rature de lâ€™eau (durÃ©e = tempÃ©rature Ã· 2)<br>
    - â„ï¸ Mode hiver avec filtration minimale (mode hiver indiquÃ© par le sensor saison)<br>
    - â˜ï¸ Conditions mÃ©tÃ©o (dÃ©sactive en cas de mauvaise conditions et rÃ©active si amÃ©lioration des conditions dans les 3h)<br>
    - ğŸŒ± Saison (adaptation dynamique de la durÃ©e)<br>
    - ğŸ§ª Mode traitement spÃ©cifique (brome, sel, algicide, floculant, etc.) avec durÃ©e prÃ©dÃ©finie et rÃ©glable<br>
    ğŸ“Œ **Recommandations gÃ©nÃ©rales pour la filtration :**<br>
    - ğŸ’§ **DurÃ©e quotidienne recommandÃ©e** = TempÃ©rature de lâ€™eau Ã· 2<br>
    - ğŸ•— **2 cycles recommandÃ©s** <br>
    - Matin : entre 6h00 et 9h00<br>
    - AprÃ¨s-midi : entre 14h00 et 18h00<br>
    - PossibilitÃ© de mettre 2 cycles intermÃ©diaire en plus<br>
    - â„ï¸ En hiver : 30â€“60 min pendant les heures les plus froides (ex. 6hâ€“8h)<br>
    - âš ï¸ Ã‰viter les heures chaudes si Ã©lectrolyse ou UV non stabilisÃ©<br>
    - ğŸ’¡ Optimisation Ã©nergÃ©tique possible avec heures creuses<br>
    ğŸ§ª **Modes de traitement disponibles** (via input_select) :<br>
    - Filtration normale - TÂ°/2 heures<br>
    - Anti-algues prÃ©ventif - 4 Ã  6h<br>
    - Anti-algues curatif - 8 Ã  12h<br>
    - Chlore lent - TÂ°/2 heures<br>
    - Chlore choc - 8 Ã  12h<br>
    - OxygÃ¨ne actif - 6 Ã  12h<br>
    - Floculant - 2 Ã  4h + arrÃªt<br>
    - pH+ ou pH- - 2 Ã  4h<br>
    - Algicide longue durÃ©e - 6 Ã  8h<br>
    - Traitement multi-actions - 6 Ã  10h<br>
    - Brome - 12 Ã  24h<br>
    - Ã‰lectrolyse au sel - 12 Ã  24h<br>
    - Anti-calcaire prÃ©ventif - 8 Ã  14h<br>
    - Anti-calcaire curatif - 12 Ã  24h<br>
    ğŸ“² **Notifications Telegram** <br>
    - Envoi de messages lors du dÃ©marrage ou de l'arrÃªt de la pompe<br>
    - Avertissement si la filtration est annulÃ©e et suspendu pour cause de mauvais temps<br>
    âš™ï¸ **Personnalisation complÃ¨te via les entrÃ©es du blueprint** :<br>
    - Capteurs de tempÃ©rature piscine et extÃ©rieure<br>
    - EntitÃ© mÃ©tÃ©o pour dÃ©sactivation pluie<br>
    - Saison dÃ©tectÃ©e automatiquement<br>
    - Configuration du volume de la piscine et du dÃ©bit de la pompe<br>
    - DurÃ©es ajustables par type de traitement<br>
    - Gestion des cycles matin/aprÃ¨s-midi<br>
    âœ… **SÃ©curitÃ© et efficacitÃ©** <br>
    - Le cycle est annulÃ© ou suspendu si du mauvais temps est dÃ©tectÃ© via le sensor mÃ©tÃ©o<br>
    - La durÃ©e du cycle n'est rÃ©initialiser a un redÃ©marrage de home assistant<br>
    - La pompe est relancÃ© si le temps change pendant le timeout aprÃ¨s detection du mauvais temps<br>
    - La pompe est arrÃªtÃ©e automatiquement en fin de cycle<br>
    - Le mode revient sur "Filtration normale" aprÃ¨s traitement spÃ©cial<br>
    ğŸ”§ *Personnalise chaque paramÃ¨tre selon ton installation, ton traitement dâ€™eau et ta stratÃ©gie Ã©nergÃ©tique.*
  domain: automation
  input:
    pompe_switch:
      name: Pompe piscine
      selector:
        entity:
          domain: switch
      description: Interrupteur de la pompe de la piscine

    input_temperature_piscine:
      name: Capteur tempÃ©rature piscine
      selector:
        entity:
          domain: sensor
          device_class: temperature
      description: Sonde de tempÃ©rature de la piscine

    input_temperature_exterieure:
      name: Sonde tempÃ©rature extÃ©rieure
      selector:
        entity:
          domain: sensor
          device_class: temperature
      description: Sonde tempÃ©rature extÃ©rieure

    input_weather_entity:
      name: EntitÃ© mÃ©tÃ©o
      selector:
        entity:
          domain: weather
      description: EntitÃ© mÃ©tÃ©o utilisÃ©e
      
    input_reglage_timeout_mauvais_temps:
      name: Reglage durÃ©e timeout mauvais temps
      default: 3
      selector:
        number:
          min: 1
          max: 7
          unit_of_measurement: "h"
      description: >
        RÃ©glage du temps du TIMEOUT entre le moment de la detection du mauvais temps et le retour a la meteo favorable pour relancer la pompe avant la fin de la durÃ©e
    
    input_saison_sensor:
      name: Capteur de saison
      selector:
        entity:
          domain: sensor
      description: Capteur saison actuel (printemps, Ã©tÃ©, automne, hiver)

    input_select_mode:
      name: Input Select mode
      selector:
        entity:
          domain: input_select
      description: >
        Menu pour choisir le mode de filtration en fonction des produits utilisÃ©s

    input_heure_cycle_matin:
      name: Heure dÃ©marrage cycle matin
      default: "06:00:00"
      selector:
        time: {}
      description: Heure de dÃ©marrage du cycle du matin

    input_activation_cycle_1:
      name: Activation 2Ã¨me cycle matin
      default: false
      selector:
        boolean: {}
      description: Active le deuxiÃ¨me cycle du matin

    input_heure_2eme_cycle_matin:
      name: Heure 2Ã¨me cycle matin
      default: "12:00:00"
      selector:
        time: {}
      description: Heure de dÃ©marrage du deuxiÃ¨me cycle du matin

    input_heure_cycle_apresmidi:
      name: Heure dÃ©marrage cycle aprÃ¨s-midi
      default: "18:00:00"
      selector:
        time: {}
      description: Heure de dÃ©marrage du cycle aprÃ¨s-midi

    input_activation_cycle_2:
      name: Activation 2Ã¨me cycle aprÃ¨s-midi
      default: false
      selector:
        boolean: {}
      description: Active le deuxiÃ¨me cycle aprÃ¨s-midi

    input_heure_2eme_cycle_apresmidi:
      name: Heure 2Ã¨me cycle aprÃ¨s-midi
      default: "00:00:00"
      selector:
        time: {}
      description: Heure du deuxiÃ¨me cycle aprÃ¨s-midi

    input_seuil_temperature:
      name: TempÃ©rature minimale pour filtration (Â°C)
      default: 12
      selector:
        number:
          min: 0
          max: 40
          unit_of_measurement: "Â°C"
      description: TempÃ©rature minimale pour activer la filtration

    input_filtration_minimale_hiver:
      name: DurÃ©e filtration minimale hiver (minutes)
      default: 30
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: "minutes"
      description: DurÃ©e minimale de filtration en hiver

    input_contenance_piscine:
      name: Contenance piscine (mÂ³)
      default: 5
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "mÂ³"
      description: Volume total de la piscine

    input_debit_pompe_piscine:
      name: DÃ©bit pompe piscine (mÂ³/h)
      default: 5
      selector:
        number:
          min: 1
          max: 20
          unit_of_measurement: "mÂ³/h"
      description: DÃ©bit nominal de la pompe

    input_duree_cycle:
      name: EntitÃ© input_number stockage durÃ©e cycle (sec)
      default: ""
      selector:
        entity:
          domain: input_number
      description: >
        Selection de l'input_number pour le stockage de la durÃ©e de filtration. 
        Il faut le crÃ©er avec cette configuration: max: 86400, min: 0 ,step: 1

    input_cycle_start:
      name: Input_datetime dÃ©but cycle
      default: ""
      selector:
        entity:
          domain: input_datetime

    input_cycle_en_cours:
      name: Input_boolean cycle en cours
      default: ""
      selector:
        entity:
          domain: input_boolean
    notification:
      name: Utilisateur Telegram
      selector:
        select:
          options:
            - 'oui'
            - 'non'
      description: Activation de Telegram pour les notifications

    reglage_anti_calcaire_preventif:
      name: Anti-calcaire prÃ©ventif
      default: 11
      selector:
        number:
          min: 8
          max: 14

    reglage_anti_calcaire_curatif:
      name: Anti-calcaire curatif
      default: 18
      selector:
        number:
          min: 12
          max: 24

    reglage_anti_algues_preventif:
      name: Anti-algues prÃ©ventif
      default: 5
      selector:
        number:
          min: 4
          max: 6

    reglage_anti_algues_curatif:
      name: Anti-algues curatif
      default: 10
      selector:
        number:
          min: 8
          max: 12

    reglage_chlore_choc:
      name: Chlore choc
      default: 10
      selector:
        number:
          min: 8
          max: 12

    reglage_oxygene_actif:
      name: OxygÃ¨ne actif
      default: 9
      selector:
        number:
          min: 6
          max: 12

    reglage_floculant:
      name: Floculant
      default: 3
      selector:
        number:
          min: 2
          max: 4

    reglage_ph:
      name: pH+ / pH-
      default: 3
      selector:
        number:
          min: 1
          max: 4

    reglage_algicide_ld:
      name: Algicide longue durÃ©e
      default: 7
      selector:
        number:
          min: 6
          max: 8

    reglage_multi_actions:
      name: Traitement multi-actions
      default: 9
      selector:
        number:
          min: 6
          max: 10

    reglage_brome:
      name: Brome
      default: 18
      selector:
        number:
          min: 12
          max: 24

    reglage_sel:
      name: Ã‰lectrolyse au sel
      default: 18
      selector:
        number:
          min: 12
          max: 24
        
variables:
  mode_entity: !input input_select_mode
  pompe_switch: !input pompe_switch
  temp_sensor_entity: !input input_temperature_piscine
  temp_exterieure_entity: !input input_temperature_exterieure
  debit_pompe: !input input_debit_pompe_piscine
  volume_piscine: !input input_contenance_piscine
  input_filtration_minimale_hiver: !input input_filtration_minimale_hiver
  seuil_temp: !input input_seuil_temperature
  saison_entity: !input input_saison_sensor
  weather_entity: !input input_weather_entity
  notification: !input notification
  r_timeout: !input input_reglage_timeout_mauvais_temps
  timeout_meteo_defavorable: "{{ (r_timeout | int * 3600) ~ 's' }}"
  cycle_start_entity: !input input_cycle_start
  duree_cycle_entity: !input input_duree_cycle
  r_acp: !input reglage_anti_calcaire_preventif
  r_acc: !input reglage_anti_calcaire_curatif
  r_aap: !input reglage_anti_algues_preventif
  r_aac: !input reglage_anti_algues_curatif
  r_cc: !input reglage_chlore_choc
  r_oa: !input reglage_oxygene_actif
  r_f: !input reglage_floculant
  r_ph: !input reglage_ph
  r_alg_ld: !input reglage_algicide_ld
  r_ma: !input reglage_multi_actions
  r_brome: !input reglage_brome
  r_sel: !input reglage_sel
  mode: "{{ states[mode_entity].state }}"
  temp_piscine: "{{ states[temp_sensor_entity].state | float(0) }}"
  temp_exterieure: "{{ states[temp_exterieure_entity].state | float(0) }}"
  saison: "{{ states[saison_entity].state | lower }}"
  weather_state: "{{ states[weather_entity].state }}"
  mode_hiver: >
    {% set s = states(saison_entity) | lower | trim %}
    {{ s in ['winter', 'hiver'] }}
  coefficient_saison: >
    {% set s = saison %}
    {% if s == 'winter' %} 0.5
    {% elif s == 'spring' %} 0.8
    {% elif s == 'summer' %} 1.2
    {% elif s == 'autumn' %} 0.7
    {% else %} 1.0
    {% endif %}
  is_rainy: >
    {% set weather = states(weather_entity).state %}
    {{ weather in ['snowy-rainy', 'hail', 'lightning-rainy', 'orage avec pluie', 'neige', 'neige fondue', 'grÃªle' ] }}
  duree_min_volume_heures: >
    {% set debit = debit_pompe | float(1) %}
    {% set volume = volume_piscine | float(1) %}
    {{ (volume / debit) | round(1) }}
  duree_heures: >
    {% if mode_hiver %}
      {{ (input_filtration_minimale_hiver | float(30)) / 60 }}
    {% else %}
      {% set m = mode %}
      {% if m == 'Filtration normale' %}
        {% set duree_temp = ((temp_piscine + (temp_exterieure * 0.3)) / 4 ) | float(0) %}
        {% set duree_volume = duree_min_volume_heures | float(0) %}
        {% set duree = [duree_temp, duree_volume] | max | round(1) %}
        {{ (duree * coefficient_saison) | round(1) }}
      {% else %}
        {% set duree_temp = (
          (temp_piscine / 2) if m == 'Chlore lent' else
          r_acp if m == 'Anti-calcaire prÃ©ventif' else
          r_acc if m == 'Anti-calcaire curatif' else
          r_aap if m == 'Anti-algues prÃ©ventif' else
          r_aac if m == 'Anti-algues curatif' else
          r_cc if m == 'Chlore choc' else
          r_oa if m == 'OxygÃ¨ne actif' else
          r_f if m == 'Floculant' else
          r_ph if m == 'pH+ ou pH-' else
          r_alg_ld if m == 'Algicide longue durÃ©e' else
          r_ma if m == 'Traitement multi-actions' else
          r_brome if m == 'Brome' else
          r_sel if m == 'Ã‰lectrolyse au sel' else
          0
        ) | float(0) %}
        {{ (duree_temp * coefficient_saison) | round(1) }}
      {% endif %}
    {% endif %}
  cycle_start_ts: "{{ as_timestamp(states(cycle_start_entity)) }}"
  duree_secondes: "{{ (duree_heures | float(0)) * 3600 }}"
  duree_finale: "{{ duree_secondes }}"
  duree_secondes_par_cycle: "{{ duree_secondes }}"
  duree_secs: "{{ duree_secondes_par_cycle | float(0) }}"
  temps_restant: "{{ [ (cycle_start_ts + duree_secs) - as_timestamp(now()), 0 ] | max }}"
  duree_heures_par_cycle: "{{ duree_heures }}"
  plage_horaire_valide: >
    {% set duree = duree_secs | float(0) %}
    {% set maintenant = now() %}

    {% set heures = [
      states('input_heure_cycle_matin'),
      is_state('input_activation_cycle_1', 'on') and states('input_heure_2eme_cycle_matin') or None,
      states('input_heure_cycle_apresmidi'),
      is_state('input_activation_cycle_2', 'on') and states('input_heure_2eme_cycle_apresmidi') or None
    ] %}

    {% for h in heures %}
      {% if h and h != 'unknown' %}
        {% set debut_str = now().date().isoformat() ~ 'T' ~ h %}
        {% set debut = debut_str | as_datetime %}
        {% if debut %}
          {% set fin = debut + timedelta(seconds=duree) %}
          {% if maintenant >= debut and maintenant <= fin %}
            {{ true }}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {{ false }}

  season_emoji: >
    {% set s = saison %}
    {% if s == 'spring' %} ğŸŒ¸
    {% elif s == 'summer' %} â˜€ï¸
    {% elif s == 'autumn' %} ğŸ‚
    {% elif s == 'winter' %} â„ï¸
    {% else %} â“
    {% endif %}
  season_label_fr: >
    {% set s = states[saison_entity].state | lower %}
    {% if s in ['spring', 'printemps'] %} printemps
    {% elif s in ['summer', 'Ã©tÃ©', 'ete'] %} Ã©tÃ©
    {% elif s in ['autumn', 'fall', 'automne'] %} automne
    {% elif s in ['winter', 'hiver'] %} hiver
    {% else %} inconnu
    {% endif %}
  weather_emoji: >
    {% set ws = weather_state %}
    {% if ws == 'clear' %} â˜€ï¸
    {% elif ws == 'cloudy' %} â˜ï¸
    {% elif ws == 'fog' %} ğŸŒ«ï¸
    {% elif ws == 'hail' %} ğŸŒ¨ï¸
    {% elif ws == 'lightning' %} ğŸŒ©ï¸
    {% elif ws == 'lightning-rainy' %} â›ˆï¸
    {% elif ws == 'partlycloudy' %} ğŸŒ¤ï¸
    {% elif ws == 'pouring' %} ğŸŒ§ï¸
    {% elif ws == 'rainy' %} ğŸŒ¦ï¸
    {% elif ws == 'snowy' %} â„ï¸
    {% elif ws == 'snowy-rainy' %} ğŸŒ¨ï¸
    {% elif ws == 'sunny' %} â˜€ï¸
    {% elif ws == 'windy' %} ğŸ’¨
    {% elif ws == 'windy-variant' %} ğŸŒ¬ï¸
    {% else %} â“
    {% endif %}
  weather_label_fr: >
    {% set ws = weather_state %}
    {% if ws == 'clear' %} ciel dÃ©gagÃ©
    {% elif ws == 'cloudy' %} nuageux
    {% elif ws == 'fog' %} brouillard
    {% elif ws == 'hail' %} grÃªle
    {% elif ws == 'lightning' %} orage
    {% elif ws == 'lightning-rainy' %} orage avec pluie
    {% elif ws == 'partlycloudy' %} partiellement nuageux
    {% elif ws == 'pouring' %} forte pluie
    {% elif ws == 'rainy' %} pluie
    {% elif ws == 'snowy' %} neige
    {% elif ws == 'snowy-rainy' %} neige fondue
    {% elif ws == 'sunny' %} ensoleillÃ©
    {% elif ws == 'windy' %} venteux
    {% elif ws == 'windy-variant' %} brise variable
    {% else %} mÃ©tÃ©o inconnue
    {% endif %}
    
  trigger_label: >
    {% set labels = {
      "cycle_matin": "horaire du matin",
      "cycle_apresmidi": "horaire de lâ€™aprÃ¨s-midi",
      "startup": "redÃ©marrage de Home Assistant",
      "mauvais_temps": "conditions mÃ©tÃ©o dÃ©favorables",
      "input_select": "changement manuel de mode"
    } %}
    {{ labels.get(trigger.id, "Ã©vÃ©nement inconnu") }}

trigger:
  - platform: state
    entity_id: !input input_select_mode
    not_to:
      - "Filtration normale"
    id: "input_select"
  - platform: state
    entity_id: !input input_weather_entity
    to:
      - pouring
      - snowy-rainy
      - hail
      - lightning-rainy
      - orage avec pluie
      - neige
      - neige fondue
      - grÃªle
    id: mauvais_temps
  - platform: time
    at: !input input_heure_cycle_apresmidi
    id: "cycle_apresmidi"
  - platform: time
    at: !input input_heure_cycle_matin
    id: "cycle_matin" 
  - platform: homeassistant
    event: start
    id: "startup"
action:
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.id == 'startup'
                 and is_state(input_cycle_en_cours, 'on')
                 and (as_timestamp(now()) - as_timestamp(states(cycle_start_entity))) < (duree_secondes | float(0)) }}
        sequence:
          - service: telegram_bot.send_message
            data:
              parse_mode: html
              disable_notification: "{{ notification == 'oui' }}"
              message: >
                ğŸ” RedÃ©marrage de Home Assistant dÃ©tectÃ©.
                â³ Un cycle de filtration Ã©tait dÃ©jÃ  en cours.
                ğŸ•’ Temps restant : {{ ((cycle_start_ts + duree_secs) - as_timestamp(now())) | timestamp_custom('%H:%M:%S', false) }}
                ğŸ”„ Reprise du cycle sans redÃ©marrer la pompe ni modifier l'heure de dÃ©part.
          - stop: "Reprise du cycle existant sans modification"
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set weather = states[weather_entity].state %}
              {{ weather in [
                'snowy-rainy', 'hail', 'lightning-rainy',
                'orage avec pluie', 'neige', 'neige fondue', 'grÃªle'
              ] }}
        sequence:
          - service: telegram_bot.send_message
            data:
              parse_mode: html
              disable_notification: "{{ notification == 'oui' }}"
              message: >
                ğŸ”” DÃ©clencheur : {{ trigger_label }}
                ğŸŒ§ï¸ Pompe NON dÃ©marrÃ©e â€” mÃ©tÃ©o dÃ©favorable : {{ weather_label_fr }}
          - stop: "MÃ©tÃ©o dÃ©favorable"

      - conditions:
          - condition: template
            value_template: "{{ not is_rainy }}"
          - condition: template
            value_template: "{{ mode_hiver or temp_piscine >= seuil_temp }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input input_cycle_start
            data:
              datetime: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
          - service: input_number.set_value
            target:
              entity_id: !input input_duree_cycle
            data:
              value: "{{ duree_secondes_par_cycle | float(0) }}"
          - service: input_boolean.turn_on
            target:
              entity_id: !input input_cycle_en_cours
          - service: switch.turn_on
            target: 
              entity_id: "{{ pompe_switch }}"
          - service: telegram_bot.send_message
            data:
              parse_mode: html
              disable_notification: "{{ notification == 'oui' }}"          
              message: >
                {% set h = duree_heures_par_cycle | int %}
                {% set m = ((duree_heures_par_cycle - h) * 60) | round(0) | int %}
                {% if mode == 'Hiver' %}
                  ğŸ”” DÃ©clencheur : {{ trigger_label }}
                  â„ï¸ Mode Hiver activÃ©
                  ğŸ’§ Pompe lancÃ©e en mode : {{ mode }}
                  ğŸ•’ DurÃ©e minimale forcÃ©e : {{ input_filtration_minimale_hiver | int }} minutes
                {% elif mode == 'Filtration normale' %}
                  {% set contenance = volume_piscine | float(0) %}
                  {% set debit = debit_pompe | float(1) %}
                  {% set duree_volume = (contenance / debit) / 2 %}
                  ğŸ”” DÃ©clencheur : {{ trigger_label }}
                  ğŸ’§ Pompe lancÃ©e en mode : {{ mode }}
                  {{ season_emoji }} Saison en cours : {{ season_label_fr }}
                  {{ weather_emoji }} MÃ©tÃ©o au moment du lancement : {{ weather_label_fr }}
                  ğŸ§® Coefficient saisonnier appliquÃ© : x{{ coefficient_saison }}
                  ğŸ•’ DurÃ©e : {{ h }}h{{ ' {:02d}min'.format(m) if m > 0 else '' }}
                  ğŸ“¦ Volume piscine : {{ volume_piscine }} mÂ³
                  ğŸš¿ DÃ©bit pompe : {{ debit_pompe }} mÂ³/h
                  ğŸ§® Calcul basÃ© sur :
                  TÂ°Ã·2 ou demi-volume {{ duree_min_volume_heures | round(1) }}h â€” valeur la plus grande retenue.
                {% else %}
                  ğŸ”” DÃ©clencheur : {{ trigger_label }}
                  ğŸ’§ Pompe lancÃ©e en mode : {{ mode }}
                  ğŸ•’ DurÃ©e : {{ h }}h{{ ' {:02d}min'.format(m) if m > 0 else '' }}
                {% endif %}

  - condition: state
    entity_id: !input input_cycle_en_cours
    state: "on"  
  - wait_for_trigger:
      - platform: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states(cycle_start_entity))) >= duree_secondes | float(0) }}

    timeout: "{{ duree_secondes | int }}"
    continue_on_timeout: true

  - service: input_boolean.turn_off
    target:
      entity_id: !input input_cycle_en_cours
  - service: switch.turn_off
    target:
      entity_id: "{{ pompe_switch }}"
  - service: telegram_bot.send_message
    data:
      parse_mode: html
      disable_notification: "{{ notification == 'oui' }}"     
      message: >
        {% set h = duree_heures_par_cycle | int %}
        {% set m = ((duree_heures_par_cycle - h) * 60) | round(0) | int %}
        {% if mode == 'Hiver' %}
          â„ï¸ Mode Hiver activÃ©
          ğŸ›‘ Pompe arrÃªtÃ©e automatiquement Ã  la fin du cycle.
          ğŸ’§ Mode : {{ mode }}
          ğŸ•’ DurÃ©e minimale effectuÃ©e : {{ input_filtration_minimale_hiver | int }} minutes
        {% elif mode == 'Filtration normale' %}
          {% set contenance = volume_piscine | float(0) %}
          {% set debit = debit_pompe | float(1) %}
          {% set duree_volume = (contenance / debit) / 2 %}
          ğŸ›‘ Pompe arrÃªtÃ©e automatiquement Ã  la fin du cycle.
          ğŸ’§ Mode : {{ mode }}
          ğŸ•’ AprÃ¨s une durÃ©e de : {{ h }}h{{ ' {:02d}min'.format(m) if m > 0 else '' }}
          ğŸ“¦ Volume piscine : {{ contenance }} mÂ³
          ğŸš¿ DÃ©bit pompe : {{ debit }} mÂ³/h
          ğŸ” Calcul : TÂ°Ã·2 ou demi-volume ({{ duree_volume | round(1) }}h) â€” valeur la plus grande retenue.
        {% else %}
          ğŸ›‘ Pompe arrÃªtÃ©e automatiquement Ã  la fin du cycle.
          ğŸ’§ Mode : {{ mode }}
          ğŸ•’ AprÃ¨s une durÃ©e de : {{ h }}h{{ ' {:02d}min'.format(m) if m > 0 else '' }}
        {% endif %}
  - service: input_number.set_value
    target:
      entity_id: !input input_cycle_en_cours
    data:
      value: 0
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ mode != 'Filtration normale' }}"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input input_select_mode
            data:
              option: "Filtration normale"

  - choose:
      - conditions:
          - condition: state
            entity_id: !input pompe_switch
            state: "on"
          - condition: template
            value_template: "{{ trigger.id == 'mauvais_temps' }}"
          - condition: template
            value_template: "{{ trigger.id == 'cycle_matin' or trigger.id == 'cycle_apresmidi' }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: "{{ pompe_switch }}"
          - service: telegram_bot.send_message
            data:
              parse_mode: html
              disable_notification: "{{ notification == 'oui' }}"             
              message: >
                ğŸ”” DÃ©clencheur : {{ trigger_label }}
                ğŸš¨ Filtration arrÃªtÃ©e Ã  cause de la mÃ©tÃ©o dÃ©favorable {{ weather_label_fr }} {{ weather_emoji }} ! En attente pour une durÃ©e de {{ r_timeout }}h d'une mÃ©tÃ©o plus favorable pour relancer la pompe.
          - wait_template: >
              {{ states(weather_entity) not in [
                'snowy-rainy', 'hail', 'lightning-rainy', 
                'orage avec pluie', 'neige', 'neige fondue', 'grÃªle'
              ] }}
            timeout: "{{ timeout_meteo_defavorable }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ wait.completed and plage_horaire_valide }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      parse_mode: html
                      disable_notification: "{{ notification == 'oui' }}"                     
                      message: "âœ… MÃ©tÃ©o redevenue favorable. Pompe relancÃ©e dans la plage horaire."
                  - service: switch.turn_on
                    target:
                      entity_id: "{{ pompe_switch }}"
              - conditions:
                  - condition: template
                    value_template: "{{ wait.completed and not plage_horaire_valide }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      parse_mode: html
                      disable_notification: "{{ notification == 'oui' }}"                     
                      message: "ğŸ”• MÃ©tÃ©o redevenue favorable, mais hors horaires dÃ©finis. Pompe non relancÃ©e."
          - stop: "fin scenario meteo"
          
mode: queued
